# ===========================================
# GITHUB ACTIONS - CI/CD Pipeline
# PetPal App - Trabajo PrÃ¡ctico Integrador
# ===========================================
#
# Este workflow hace lo siguiente:
# 1. Push/PR a main â†’ Ejecuta tests unitarios
# 2. Si pasan â†’ Deploy a QA + Tests de integraciÃ³n
# 3. Si pasan â†’ Espera APROBACIÃ“N MANUAL
# 4. Con aprobaciÃ³n â†’ Deploy a PRODUCCIÃ“N
#
# ===========================================

name: CI/CD Pipeline - PetPal

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permite ejecutar manualmente

env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # JOB 1: TESTS UNITARIOS
  # ============================================
  unit-tests:
    name: ğŸ§ª Tests Unitarios
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Instalar dependencias
        run: npm ci

      - name: ğŸ§ª Ejecutar Tests Unitarios
        run: npm run test:unit -- --ci --coverage
        continue-on-error: false  # âŒ FALLA si tests fallan

      - name: ğŸ“Š Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ğŸ“‹ Subir reporte JUnit
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-unit
          path: reports/
          retention-days: 30

      - name: ğŸ“ˆ Comentar cobertura en PR
        uses: MishaKav/jest-coverage-comment@main
        if: github.event_name == 'pull_request'
        with:
          coverage-summary-path: ./coverage/coverage-summary.json

  # ============================================
  # JOB 2: BUILD
  # ============================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: unit-tests  # Solo si tests unitarios pasan
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Instalar dependencias
        run: npm ci

      - name: ğŸ”¨ Build para Web
        run: npm run build:web
        env:
          EXPO_PUBLIC_API_URL: ${{ secrets.API_URL_QA }}

      - name: ğŸ“¦ Subir artefacto de build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/
          retention-days: 30

  # ============================================
  # JOB 3: DEPLOY A QA + TESTS INTEGRACIÃ“N
  # ============================================
  deploy-qa:
    name: ğŸš€ Deploy QA + Tests IntegraciÃ³n
    runs-on: ubuntu-latest
    needs: build
    environment: qa  # Ambiente de QA
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Descargar artefacto de build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/

      - name: ğŸš€ Deploy a QA (Ejemplo con Vercel)
        run: |
          echo "ğŸš€ Desplegando a ambiente QA..."
          echo "ğŸ“Œ URL de QA: https://petpal-qa.vercel.app"
          # AquÃ­ irÃ­an los comandos reales de deploy, ejemplo:
          # npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ“š Instalar dependencias para tests
        run: npm ci

      - name: ğŸ”— Ejecutar Tests de IntegraciÃ³n
        run: npm run test:integration -- --ci
        continue-on-error: false  # âŒ FALLA si tests fallan
        env:
          API_URL: ${{ secrets.API_URL_QA }}

      - name: ğŸ“‹ Subir reporte de integraciÃ³n
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-integration
          path: reports/
          retention-days: 30

  # ============================================
  # JOB 4: APROBACIÃ“N MANUAL
  # ============================================
  approval-gate:
    name: â¸ï¸ AprobaciÃ³n Manual
    runs-on: ubuntu-latest
    needs: deploy-qa
    environment: 
      name: production-approval
      # âš ï¸ IMPORTANTE: Configurar en GitHub:
      # Settings â†’ Environments â†’ production-approval
      # - Required reviewers: [tu usuario]
    
    steps:
      - name: âœ… AprobaciÃ³n recibida
        run: echo "âœ… Deploy a producciÃ³n aprobado manualmente"

  # ============================================
  # JOB 5: DEPLOY A PRODUCCIÃ“N
  # ============================================
  deploy-production:
    name: ğŸŒŸ Deploy ProducciÃ³n
    runs-on: ubuntu-latest
    needs: approval-gate
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar artefacto de build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/

      - name: ğŸŒŸ Deploy a ProducciÃ³n
        run: |
          echo "ğŸŒŸ Desplegando a PRODUCCIÃ“N..."
          echo "ğŸ“Œ URL: https://petpal-app.vercel.app"
          # Comandos reales de deploy a producciÃ³n
          # npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ‰ Deploy completado
        run: |
          echo "============================================"
          echo "ğŸ‰ DEPLOY A PRODUCCIÃ“N COMPLETADO"
          echo "ğŸ“Œ VersiÃ³n: ${{ github.sha }}"
          echo "ğŸ“… Fecha: $(date)"
          echo "============================================"
